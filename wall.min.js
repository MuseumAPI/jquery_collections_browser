/*
 * Victoria and Albert Museum Collections Browser jQuery plugin
 * http://www.vam.ac.uk/
 *
 * Copyright 2011, Victoria and Albert Museum
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */
(function(a){a.fn.wall=function(b){return this.each(function(){var z={width:1024,height:768,sizes:[{dim:130,suff:"_jpg_o",name:"Small images"},{dim:177,suff:"_jpg_ws",name:"Medium images"},{dim:265,suff:"_jpg_w",name:"Large images"},{dim:355,suff:"_jpg_ds",name:"X-Large images"}],start_size:2,tile_margin:8,sidebar_image_size:265,background_color:"#ffffff",tile_border_color:"#a1a1a1",img_fadein:500,fullscreen_speed:250,min_category_count:30,padding:8,wall_border:"1px solid #a1a1a1",panel_width:"auto",hide_loader_time:2000,fill_direction:"random",tag_style:"list",show_loading:false,show_more_link:false,enable_history:false,enable_clipboard:false,max_history:20,search_box_default:"New search",alert_title:"Oops",alert_msg_no_images:"Sorry, there are not enough images for that search to fill the screen.",alert_msg_enter_search:"Please enter a search term and try again.",alert_msg_zoom_max:"Sorry, cannot zoom in any further.",alert_msg_zoom_min:"Sorry, cannot zoom out any further.",title_no_term:"Showing 1000 selected images.",tips:["Try dragging the image grid to reveal more images.","You can change the size of the tiles using the zoom buttons in the panel below.","You can shuffle the images using the button in the panel below.","Try switching to full screen and back using the toggle fullscreen button.","Click on an image to reveal the sidebar with more information about the object.","You can load images from a category by clicking the category names in the sidebar.","You can drag this window.","You can search for similar objects by clicking the object name in the sidebar.","The search returns a maximum of 1000 objects.","You can see the list of searches you've done by clicking the toggle history button in the panel."],api_stub:"http://www.vam.ac.uk/api/json/museumobject/",api_search_path:"search",images_url:"http://media.vam.ac.uk/media/thira/collection_images/",collections_record_url:"http://collections.vam.ac.uk/item/",search_term:"",category:{id:null,name:"",term:""},max_results:1000,limit:41,search_term:"","category-stub":"",sidebar_image_suffix:"_jpg_w",large_image_suffix:"_jpg_l",blank_tile:'<li class="blank"></li>',cache_interval:50,fill_interval:5,taxonomy:["styles","collections","subjects","names","exhibitions","galleries","techniques","materials","categories","places"],tombstone:[["Artist","artist"],["Date","date_text"],["Museum no.","museum_number"],["Materials &amp; techniques","materials_techniques"],["Location","location"],["Place","place"],["History note","history_note"]],event_click_sidebar_img:function(L){L.preventDefault();fs=a("#fullsize","#wall");if(!fullsize_dragged){fs.css({top:0,left:0})}fs.show()}};var I=a.extend({},z,b);E(a(this),I);function E(W,O){O.current_size=O.start_size;O.tile_w=O.sizes[O.current_size].dim;O.tile_h=O.sizes[O.current_size].dim;O.tile_sidebar_image_suffix=O.sizes[O.current_size].suff;O.cell_w=O.tile_w+O.tile_margin+2;O.cell_h=O.tile_h+O.tile_margin+2;O.start_rows=Math.ceil(O.height/O.cell_h);O.start_cols=Math.ceil(O.width/O.cell_w);O.sidebar_width=O.sidebar_image_size;var X='<div id="grid">';for(i=0;i<O.start_rows;i++){X+=w(O.start_cols)}X+="</div>";W.html(X);O.start={top:W.position().top,left:W.position().left};O.fullscreen=false;W.css({width:O.width,height:O.height,"background-color":O.background_color,border:O.wall_border});a("#grid",W).css({width:O.cell_w*O.start_cols});F(W);var L='<div id="panel" class="ui-widget ui-widget-content ui-corner-all">';L+='<ul id="icons">';L+='<li><input class="ui-state-default ui-corner-all" type="text" name="search" value="'+O.search_box_default+'"></li>';L+='<li class="ui-state-default ui-corner-all"><span class="submitsearch ui-icon ui-icon-search" title="Submit search"></span></li>';L+='<li class="ui-state-default ui-corner-all"><span class="fullscreen ui-icon ui-icon-arrow-4-diag" title="Toggle full screen"></span></li>';L+='<li class="ui-state-default ui-corner-all"><span class="shuffle ui-icon ui-icon-shuffle" title="Shuffle images"></span></li>';L+='<li class="ui-state-default ui-corner-all"><span class="zoomin ui-icon ui-icon-zoomin" title="Larger tiles"></span></li>';L+='<li class="ui-state-default ui-corner-all"><span class="zoomout ui-icon ui-icon-zoomout" title="Smaller tiles"></span></li>';if(O.enable_history){L+='<li class="ui-state-default ui-corner-all"><span class="togglehist ui-icon ui-icon-clock" title="Toggle history panel"></span></li>'}if(O.enable_clipboard){L+='<li class="ui-state-default ui-corner-all"><span class="toggleclip ui-icon ui-icon-clipboard" title="Toggle clipboard"></span></li>'}L+="</ul>";L+="</div>";var R='<div id="sidebar"  class="ui-dialog ui-widget ui-widget-content ui-corner-all">';R+='<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title object-title"></span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div>';R+='<div class="sidebar_image"></div>';R+='<div class="sidebar_info"></div>';R+="</div>";var U='<div id="dialog" class="ui-dialog ui-widget ui-widget-content ui-corner-all">';U+='<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title">'+O.alert_title+'</span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div>';U+='<p><span style="float: left; margin-right: .3em;" class="ui-icon ui-icon-alert"></span><span id="dialog_text"></span></p>';U+='<div class="ui-dialog-buttonpane ui-widget-content ui-helper-clearfix"><div class="ui-dialog-buttonset"><button type="button" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false"><span class="ui-button-text">Ok</span></button></div></div>';U+="</div>";var N='<div id="loading" class="ui-dialog ui-widget ui-widget-content ui-corner-all">';N+='<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title">Please wait...</span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div>';N+='<p class="results_info"></p>';N+='<div id="progressbar"></div>';N+="</div>";var V='<div id="title" class="ui-dialog ui-widget ui-widget-content ui-corner-all">';V+='<p class="title_info"></p>';V+="</div>";var S='<div id="fullsize" class="ui-dialog ui-widget ui-widget-content ui-corner-all">';S+='<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title"></span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div>';S+='<img src="" alt="" title="" />';S+="</div>";var T='<div id="hist" class="ui-dialog ui-widget ui-widget-content ui-corner-all">';T+='<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title">Your history</span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div>';T+='<div id="histlist" class="ui-widget ui-state-highlight ui-corner-all hide"><ul class="list"></ul></div>';T+="</div>";var Q='<div id="clipboard" class="ui-dialog ui-widget ui-widget-content ui-corner-all">';Q+='<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title">Your clipboard</span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div>';Q+='<div id="clipboardlist" class="ui-widget ui-state-highlight ui-corner-all hide"><ul class="list"></ul><div class="clearfix"></div></div>';Q+="</div>";var P='<div id="disabled" class="ui-widget-overlay"></div>';a("#grid").after(R).after(L).after(U).after(N).after(V).after(S).after(P).after(T).after(Q);var M=a("#panel");M.css({left:W.width()/2-M.width()/2,bottom:0});allow_shuffle=false;fullsize_dragged=false;cache_full=false;O.browse_hist=[];O.cliplist=[];O.clipboard=[];C(W,O);a("#grid",W).draggable({cursor:"pointer",delay:150,stop:function(){y(a(this.parentNode))}});a("#loading",W).draggable({containment:"parent"});a("#fullsize",W).draggable({containment:"parent",stop:function(){fullsize_dragged=true}});a("#hist",W).draggable({containment:"parent"});a("#clipboard",W).draggable({containment:"parent"});W.delegate("#icons li span","mouseover",function(Y){a(this).parent().addClass("ui-state-hover")}).delegate("#icons li span","mouseout",function(Y){a(this).parent().removeClass("ui-state-hover")}).delegate("#panel span.fullscreen","click",function(Y){Y.preventDefault();var Z=a("#sidebar",W);if(O.fullscreen){a("body").css({overflow:"auto"});W.prependTo(old_parent).animate({width:O.width,height:O.height,},O.fullscreen_speed,function(){if(Z.is(":visible")){Z.animate({width:O.sidebar_width,height:W.height()-2*O.padding,top:0,left:W.width()-(O.sidebar_width+2*O.padding),padding:O.padding},O.fullscreen_speed,function(){})}var ab=a("#panel",W);a("#sidebar").hide();ab.css({left:0}).css({left:W.width()/2-ab.width()/2,bottom:0});var aa=a("#loading");aa.css({left:W.width()/2-aa.width()/2,});O.fullscreen=false;y(W)})}else{old_parent=W.parent();W.prependTo(a("body"));a("body").css({overflow:"hidden"});a(window).scrollTop(0);W.animate({width:a(document).width(),height:a(window).height(),},O.fullscreen_speed,function(){if(Z.is(":visible")){Z.animate({width:O.sidebar_width,height:W.height()-2*O.padding,top:0,left:W.width()-(O.sidebar_width+2*O.padding),padding:O.padding},O.fullscreen_speed,function(){a(".sidebar_info",Z).height(Z.height()-a(".sidebar_image").height())})}var ab=a("#panel");ab.css({left:W.width()/2-ab.width()/2,bottom:0});var aa=a("#loading");aa.css({left:W.width()/2-aa.width()/2,});O.fullscreen=true;y(W)})}}).delegate("#panel span.zoomin","click",function(Y){Y.preventDefault();max_size=O.sizes.length-1;if(O.current_size<max_size){O.current_size++;K(W)}else{A(W,O.alert_msg_zoom_max)}}).delegate("#panel span.zoomout","click",function(Y){if(O.current_size>0){O.current_size--;K(W)}else{A(W,O.alert_msg_zoom_min)}}).delegate("#panel span.togglehist","click",function(Y){a("#hist",W).toggle("fast")}).delegate("#panel span.toggleclip","click",function(Y){a("#clipboard",W).toggle("fast")}).delegate("#panel span.submitsearch","click",function(Y){search_term=a('#panel input[name="search"]',W).val();if(search_term!=""&&search_term!=O.search_box_default){O.category={id:null,name:"",term:"",};O.search_term=search_term;C(W,O)}else{A(W,O.alert_msg_enter_search)}}).delegate('#panel input[name="search"]',"keyup",function(Z){Z.preventDefault();var Y=(Z.keyCode?Z.keyCode:Z.which);if(Y==13){search_term=a(this).val();if(search_term!=""&&search_term!=O.search_box_default){O.category={id:null,name:"",term:""};O.search_term=search_term;C(W,O)}else{A(W,O.alert_msg_enter_search)}}}).delegate('#panel input[name="search"]',"focus",function(Y){Y.preventDefault();a(this).val("")}).delegate('#panel input[name="search"]',"click",function(Y){Y.preventDefault();a(this).val("")}).delegate("#histlist a","click",function(Y){Y.preventDefault();if(a(this).data("search_term")){O.category={id:null,name:"",term:""};O.search_term=a(this).data("search_term")}else{O.category={id:a(this).data("pk"),name:a(this).data("name"),term:a(this).data("term")}}C(W,O)}).delegate(".searchable","click",function(Y){search_term=a(this).html();a('#panel input[name="search"]',W).val(search_term);if(search_term!=""&&search_term!=O.search_box_default){O.category={id:null,name:"",term:""};O.search_term=search_term;C(W,O)}else{A(W,O.alert_msg_enter_search)}}).delegate("#panel span.shuffle","click",function(Y){if(allow_shuffle){keys=[];shuffle=[];for(d=0;d<O.max_offset;d++){shuffle[Math.random()*1]=d}for(r in shuffle){keys.push(r)}keys.sort();tiles=a("#grid li",W);count=0;for(k in keys){h(a(tiles[count]),D(shuffle[keys[k]],cache));count++}}}).delegate(".ui-dialog-titlebar-close","click",function(Y){Y.preventDefault();a(this).parent().parent().hide()}).delegate("button","click",function(Y){Y.preventDefault();a("#dialog",W).hide()}).delegate("#grid ul li","click",function(Y){H(W,a(this).data("objnum"))}).delegate("#sidebar a.save","click",function(Y){Y.preventDefault();objnum=a(this).data("objnum");imref=a(this).data("imref");clipobj={objnum:objnum,name:a(this).data("name"),img:O.images_url+imref.substr(0,6)+"/"+imref+"_jpg_s.jpg"};if(a.inArray(a(this).data("objnum"),O.cliplist)==-1){O.cliplist.push(objnum);O.clipboard.push(clipobj);var Z='<li data-objnum="'+objnum+'">';Z+='<img src="'+clipobj.img+'" alt="'+clipobj.name+'" title="'+clipobj.name+'" />';Z+="</li>";a("#clipboardlist ul").append(Z);a("#clipboardlist").show()}}).delegate("#clipboard li","click",function(Y){H(W,a(this).data("objnum"))}).delegate("#sidebar a.close","click",function(Y){Y.preventDefault();a("#sidebar",W).hide()}).delegate("#browse a","click",function(Y){Y.preventDefault();O.category={id:a(this).data("pk"),name:a(this).data("name"),term:a(this).data("term"),};C(W,O);a('#panel input[name="search"]',W).val("New search")}).delegate("#sidebar img","click",O.event_click_sidebar_img)}function g(L){l=a("#loading");l.css({left:L.width()/2-l.width()/2,top:L.height()/2-l.height()/2});a("span.ui-dialog-title",l).html("Please wait...");l.show()}function A(L,M){dia=a("#dialog",L);a("#dialog_text",dia).html(M);dia.css({left:L.width()/2-dia.width()/2,top:L.height()/2-dia.height()/2});dia.show()}function H(L,O){url=I.api_stub+O;a("#fullsize").hide();var N=a("#sidebar",L);N.css({width:I.sidebar_width,height:L.height()-2*I.padding,top:0,left:L.width()-(I.sidebar_width+2*I.padding),padding:I.padding});var M=a("#disabled",L);M.css({width:I.sidebar_width,height:L.height()-2*I.padding,top:0,left:L.width()-(I.sidebar_width+2*I.padding),padding:I.padding,"z-index":50}).show();if(!N.is(":visible")){N.show()}a.ajax({dataType:"jsonp",url:url,success:function(R){musobj=R[0].fields;image_url=I.images_url+musobj.primary_image_id.substr(0,6)+"/"+musobj.primary_image_id+I.sidebar_image_suffix+".jpg";objname=musobj.object;objtitle='<span id="objname" class="searchable" title="Search for \''+objname+"'\">"+objname+"</span>";if(musobj.title){objname+=": "+musobj.title;objtitle+=": "+musobj.title}var S='<img src="'+image_url+'" title="'+objname+'" alt="'+objname+'" width="'+I.sidebar_image_size+'" height="'+I.sidebar_image_size+'" data-objnum="'+musobj.object_number+'">';a("span.object-title",N).html('<span class="ui-icon ui-icon-search" style="float: left; margin-right: 2px;"></span>'+objtitle);if(I.show_more_link){var Q='<div class="ui-widget ui-state-highlight ui-corner-all"><div><span class="ui-icon ui-icon-extlink" style="float:left;"></span><a href="'+I.collections_record_url+musobj.object_number+'">More details</a></div>';if(I.enable_clipboard){Q+='<div><span class="ui-icon ui-icon-copy" style="float:left;"></span><a data-name="'+objname+'" data-objnum="'+musobj.object_number+'" data-imref="'+musobj.primary_image_id+'" class="save" href="#" title="Save this object to your clipboard">Save</a></div></div>'}}else{var Q=""}if(typeof(musobj.descriptive_line)!="undefined"&&musobj.descriptive_line!=""&&musobj.descriptive_line!=["Unknown"]){Q+='<div class="ui-widget ui-state-highlight ui-corner-all">'+musobj.descriptive_line+"</div>"}Q+='<div class="ui-widget ui-state-highlight ui-corner-all">';Q+="<ul>";for(k=0;k<I.tombstone.length;k++){t=I.tombstone[k][0];c=I.tombstone[k][1];if(typeof(musobj[c])!="undefined"&&musobj[c]!=""&&musobj[c]!=["Unknown"]){Q+="<li><strong>"+t+"</strong>: "+musobj[c]+"</li>"}}Q+="</ul></div>";Q+='<div class="ui-widget ui-state-highlight ui-corner-all" id="browse">';Q+='<ul class="'+I.tag_style+'">';var P=0;for(k=0;k<I.taxonomy.length;k++){category=musobj[I.taxonomy[k]];if(B(category)>0){taxonomy_title=J(I.taxonomy[k]);P++;if(I.tag_style=="list"){Q+="<li><strong>"+taxonomy_title+"</strong>";Q+="<ul>"}for(p=0;p<category.length;p++){s=Math.floor(Math.random()*6);cat=category[p];category_name=J(cat.fields.name);if(cat.fields.museumobject_count>I.min_category_count&&category_name!="Unknown"){P++;Q+='<li class="size-'+parseInt(s)+'"><a href="#" data-name="'+cat.model.split(".")[1]+'" data-pk="'+cat.pk+'" data-term="'+category_name+'" title="Browse images for \''+category_name+"'\">"+category_name+"</a></li>"}}if(I.tag_style=="list"){Q+="</ul>"}Q+="</li>"}}if(P==0){Q+="<li>Sorry, no categories for this object.</li>"}Q+='</ul><div class="clearfix"></div></div>';a(".sidebar_image",N).html(S);a(".sidebar_info",N).html(Q).height(N.height()-a(".sidebar_image").outerHeight()-a(".ui-dialog-titlebar",N).outerHeight()).scrollTop(0);var T=new Image();T.src=image_url.replace(I.sidebar_image_suffix,I.large_image_suffix);a("#fullsize img",L).attr("src",T.src);a("#fullsize .ui-dialog-title").html(objname);M.fadeOut()}})}function C(L,M){ajax_in_progress=true;a("#panel .shuffle").addClass("disabled");allow_shuffle=false;a.ajax({dataType:"jsonp",url:v(),success:function(O){if(O.meta.result_count<=M.min_category_count){A(L,M.alert_msg_no_images)}else{if(M.show_loading){g(L)}if(typeof(cache_loop_id)!="undefined"){clearInterval(cache_loop_id)}if(typeof(fill_loop_id)!="undefined"){clearInterval(fill_loop_id)}if(typeof(cache)!="undefined"){delete cache}offset=0;a("#grid ul li",L).addClass("blank");M.num_results=(O.meta.result_count>M.max_results)?M.max_results:O.meta.result_count;M.display_results=parseInt(M.num_results);M.grid_width=Math.floor(Math.sqrt(M.num_results));M.grid_height=M.grid_width;M.max_offset=M.grid_width*M.grid_height;in_hist=false;if(M.category.id!=null){var P="Showing "+M.num_results+' images for <span class="">'+J(M.category.name)+": "+J(M.category.term)+"</span>";var N=M.category.id+M.category.name+M.category.term;N=N.replace(/ /gi,"").toLowerCase();if(a.inArray(N,M.browse_hist)==-1){M.browse_hist.push(N);a("#histlist ul").append('<li><a href="#" data-name="'+M.category.name+'" data-pk="'+M.category.id+'" data-term="'+M.category.term+'">'+J(M.category.name)+": "+M.category.term+"</a></li>")}a("#histlist").show()}else{if(M.search_term!=""){var P="Showing "+M.num_results+' images for <span class="">'+M.search_term+"</span>";if(a.inArray(M.search_term,M.browse_hist)==-1){a("#histlist ul").append('<li><a href="#" data-search_term="'+M.search_term+'" title="Search for \''+M.search_term+"'\">Search: "+M.search_term+"</a></li>");M.browse_hist.push(M.search_term)}a("#histlist").show()}else{var P=M.title_no_term}}if(M.browse_hist.length>M.max_history){a("#histlist li:first").remove();M.browse_hist.shift()}a("#title .title_info",L).html(P);a("#progressbar").progressbar({value:0,max:M.max_offset});a("#loading p.results_info",L).html('Loading <strong><span class="loaded">0</span>/'+M.display_results+"</strong> images");offset_anchor=0;num_cols=a("#grid>ul:first li",L).size();tiles=a("#grid>ul>li",L);count=0;row=0;o=offset_anchor;for(k=0;k<tiles.size();k++){a(tiles[k]).data("offset",o);count++;if(count==num_cols){count=0;row++;o=row*M.grid_width}else{o++}}ajax_in_progress=false;cache=new Array();cache_loop_id=setInterval(function(){f(M,cache)},M.cache_interval);fill_loop_id=setInterval(function(){x(M,cache)},M.fill_interval)}}});return true}function K(L){d=I.sizes[I.current_size];I.tile_w=d.dim;I.tile_h=d.dim;I.cell_w=I.tile_w+I.tile_margin+2;I.cell_h=I.tile_h+I.tile_margin+2;I.start_rows=Math.ceil(I.height/I.cell_h);I.start_cols=Math.ceil(I.width/I.cell_w);I.tile_sidebar_image_suffix=d.suff;a("#grid",L).html("");a("#panel a.resize").removeClass("selected");a(this).addClass("selected");y(L);offset_anchor=0;num_cols=a("#grid>ul:first li",L).size();tiles=a("#grid>ul>li",L);count=0;row=0;o=offset_anchor;for(k=0;k<tiles.size();k++){a(tiles[k]).data("offset",o);count++;if(count==num_cols){count=0;row++;o=row*I.grid_width}else{o++}}}function v(M,L){if(typeof(M)=="undefined"||isNaN(M)){M=0}if(typeof(L)=="undefined"||isNaN(L)){L=1}if(I.category.id!=null){url=I.api_stub;url+="?"+I.category.name+"="+I.category.id;url+="&getgroup="+I.category.name;display_term=J(I.category.term)}else{url=I.api_stub+I.api_search_path;url+="?q="+I.search_term;display_term=J(I.search_term)}url+="&limit="+L;url+="&offset="+M;url+="&images=1";return url}function w(L){r="<ul>";for(j=0;j<L;j++){r+=I.blank_tile}r+="</ul>";return r}function F(L){a("#grid li",L).css({width:I.tile_w,height:I.tile_h,"margin-right":I.tile_margin,"margin-bottom":I.tile_margin,"border-color":I.tile_border_color})}function B(L){var M=0;for(n=0;n<L.length;n++){if(L[0].fields.name!="Unknown"&&L[0].fields.museumobject_count>I.min_category_count){M++}}return M}function J(L){return L.charAt(0).toUpperCase()+L.substr(1)}function y(L){offset_anchor=a("#grid ul:first li:first",L).data("offset");var M=a("#grid",L);M.width(M.width()+L.position().left+L.width());tiles={N:Math.ceil(M.position().top/I.cell_h),S:Math.ceil((L.height()-M.position().top+M.height())/I.cell_h),E:Math.ceil((M.position().left+M.width())/I.cell_w),W:Math.ceil(M.position().left/I.cell_w)};for(prop in tiles){tiles[prop]=tiles[prop]<0?0:tiles[prop]}do_offsets=false;if(tiles.N){for(i=0;i<tiles.N;i++){M.prepend(w(a("#grid ul:first > li",L).size()))}do_offsets=true}if(tiles.S){for(i=0;i<tiles.S;i++){M.append(w(a("#grid ul:first > li",L).size()))}do_offsets=true}if(tiles.W){tl="";for(i=0;i<tiles.W;i++){tl+=I.blank_tile}a("#grid ul",L).prepend(tl);do_offsets=true}if(tiles.E){tr="";for(i=0;i<tiles.E;i++){tr+=I.blank_tile}a("#grid ul",L).append(tr);do_offsets=true}M.css({top:tiles.N>0?M.position().top-tiles.N*I.cell_h:M.position().top,left:tiles.W>0?M.position().left-tiles.W*I.cell_w:M.position().left,width:a("#grid ul:first > li",L).length*I.cell_w});F(L);remove={N:Math.floor(M.position().top*-1/I.cell_h),S:Math.floor((M.height()-L.height()+M.position().top)/I.cell_h),E:Math.floor((M.width()-L.width()+M.position().left)/I.cell_w),W:Math.floor(M.position().left*-1/I.cell_w)};for(p in remove){remove[p]=remove[p]<0?0:remove[p]}tiles_removed=0;while(tiles_removed<remove.W){a("#grid ul li:first-child").remove();tiles_removed++;M.css({left:M.position().left+I.cell_w})}tiles_removed=0;while(tiles_removed<remove.E){a("#grid ul li:last-child").remove();tiles_removed++}rows_removed=0;while(rows_removed<remove.N){a("#grid ul:first-child").remove();rows_removed++;M.css({top:M.position().top+I.cell_h})}rows_removed=0;while(rows_removed<remove.S){a("#grid ul:last-child").remove();rows_removed++}M.width(a("#grid ul:first > li",L).length*I.cell_w);if(do_offsets){e(L,tiles,remove,I)}}function e(M,N,L,O){offset_anchor=parseInt(offset_anchor);if(N.N>0){offset_anchor-=O.grid_width*N.N;if(offset_anchor<0){offset_anchor+=O.max_offset}}if(N.W>0){min=Math.floor(offset_anchor/O.grid_width)*O.grid_width;max=min+O.grid_width-1;offset_anchor-=N.W;if(offset_anchor<min){offset_anchor+=O.grid_width}}offset_anchor+=L.W;offset_anchor-=L.N*O.grid_width;if(offset_anchor<0){offset_anchor=0}offset=offset_anchor-O.limit;num_cols=a("#grid>ul:first li",M).size();rows=a("#grid>ul");for(j=0;j<rows.size();j++){o=offset_anchor+(j*O.grid_width);if(o>=O.max_offset){o-=O.max_offset}N=a("li",rows[j]);min=Math.floor(o/O.grid_width)*O.grid_width;max=min+O.grid_width-1;for(i=0;i<N.size();i++){a(N[i]).data("offset",o);o++;if(o>max){o=min}}o=max+1;if(o>=O.max_offset-1){o-=O.max_offset}}}function G(L,M){try{u=L+M.substr(0,6)+"/"+M+I.tile_sidebar_image_suffix+".jpg"}catch(N){u=""}return u}function D(L){for(q in cache){if(cache[q].offset==L){return cache[q]}}if(cache_full){a.ajax({dataType:"jsonp",url:v(L,1),success:function(M){for(i=0;i<M.records.length;i++){record=M.records[i];obj={};obj.offset=L;obj.imref=record.fields.primary_image_id;obj.num=record.fields.object_number;if(record.fields.title){objname=record.fields.object+" "+record.fields.title}else{objname=record.fields.object}obj.title=objname;cache.push(obj)}}})}return false}function f(M,L){if(typeof(offset)=="undefined"||isNaN(offset)||offset<0){offset=0}if(L.length<M.max_offset){cache_full=false;if(!ajax_in_progress){ajax_in_progress=true;url=v(offset,M.limit);a.ajax({dataType:"jsonp",url:url,success:function(N){for(i=0;i<N.records.length;i++){record=N.records[i];cache_obj={};cache_obj.offset=offset;cache_obj.imref=record.fields.primary_image_id;cache_obj.num=record.fields.object_number;if(record.fields.title){objname=record.fields.object+" "+record.fields.title}else{objname=record.fields.object}cache_obj.title=objname;L.push(cache_obj);offset++}if(offset>=M.max_offset&&L.length<M.max_offset){offset=0}ajax_in_progress=false;a("#progressbar").progressbar({value:L.length});a("#loading .loaded").html(L.length)}})}}else{a("#panel .shuffle").removeClass("disabled");allow_shuffle=true;clearInterval(cache_loop_id);cache_full=true;setTimeout(m,M.hide_loader_time);a("#loading .loaded").html(M.display_results);r=Math.floor(Math.random()*M.tips.length);a("#loading span.ui-dialog-title").html("Done.");a("#loading .results_info").html('<span style="float: left; margin-right: .3em;" class="ui-icon ui-icon-info"></span><strong>Tip:</strong> '+M.tips[r])}}function m(){a("#loading").fadeOut()}function h(M,L){if(M&&typeof(M)!="undefined"){M.css({"background-image":"url("+G(I.images_url,L.imref)+")"}).attr("title",L.title+" ["+L.num+"]").data("objnum",L.num).removeClass("blank")}}function x(M,L){switch(M.fill_direction){case"forwards":t=a("ul li.blank:first");break;case"backwards":t=a("ul li.blank:last");break;case"random":tt=a("ul li.blank");t=a(tt[Math.floor(Math.random()*tt.length)]);break;default:t=a("ul li.blank:first");break}var N=D(t.data("offset"),L);if(N){h(t,N)}}})}})(jQuery);