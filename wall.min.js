/*
 * Victoria and Albert Museum Collections Browser jQuery plugin
 * http://www.vam.ac.uk/
 *
 * Copyright 2011, Victoria and Albert Museum
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */
(function(a){a.fn.centerHoriz=function(){return this.each(function(){var b=a(this);b.css({left:b.parent().width()/2-b.width()/2})})};a.fn.centerVert=function(){return this.each(function(){var b=a(this);b.css({top:b.parent().height()/2-b.height()/2})})};a.fn.wall=function(f){var w=this;var q={width:1024,height:768,sizes:[{dim:130,suff:"_jpg_o",name:"Small images"},{dim:177,suff:"_jpg_ws",name:"Medium images"},{dim:265,suff:"_jpg_w",name:"Large images"},{dim:355,suff:"_jpg_ds",name:"X-Large images"}],start_size:2,tile_margin:8,sidebar_image_size:265,background_color:"#ffffff",tile_border_color:"#a1a1a1",img_fadein:500,fullscreen_speed:250,min_category_count:30,padding:8,wall_border:"1px solid #a1a1a1",panel_width:"auto",hide_loader_time:2000,fill_direction:"random",tag_style:"list",show_loading:false,show_loading_numbers:false,show_more_link:false,enable_history:false,enable_clipboard:false,enable_map:false,max_history:20,hide_controls_on_load:false,logo:false,image_counts_in_sidebar:false,search_box_default:"New search",alert_title:"Oops",alert_msg_no_images:"Sorry, there are not enough images for that search to fill the screen.",alert_msg_enter_search:"Please enter a search term and try again.",alert_msg_zoom_max:"Sorry, cannot zoom in any further.",alert_msg_zoom_min:"Sorry, cannot zoom out any further.",title_no_term:"Showing 1000 selected images.",loading_msg:"Loading...",tips:["Drag the grid or click the button in the corner to reveal more images.","Try dragging the image grid to reveal more images.","You can change the size of the images using the zoom buttons in the panel below.","You can shuffle the images using the button in the panel below.","Try switching to full screen and back using the toggle fullscreen button.","Click on an image to reveal the sidebar with more information about the object.","You can load images from a category by clicking the category names in the sidebar.","You can drag this window.","You can search for similar objects by clicking the object name in the sidebar.","The search returns a maximum of 1000 objects.","You can see the list of searches you've done by clicking the toggle history button in the panel.","Click the map button in the panel to view the current set on a map."],start_tip:0,api_stub:"http://www.vam.ac.uk/api/json/museumobject/",api_search_path:"search",images_url:"http://media.vam.ac.uk/media/thira/collection_images/",collections_record_url:"http://collections.vam.ac.uk/item/",search_term:"",category:{id:null,name:"",term:""},max_results:250,limit:50,search_term:"","category-stub":"",sidebar_image_suffix:"_jpg_w",large_image_suffix:"_jpg_l",map_start_lat:51.49645,map_start_lng:-0.17197,blank_tile:'<li class="blank"></li>',cache_interval:50,fill_interval:5,taxonomy:["styles","collections","subjects","names","exhibitions","galleries","techniques","materials","categories","places"],tombstone:[["Artist","artist"],["Date","date_text"],["Museum no.","museum_number"],["Materials &amp; techniques","materials_techniques"],["Location","location"],["Place","place"],["History note","history_note"]],event_click_sidebar_img:function(D){D.preventDefault();var i=a("#fullsize",w);if(!t){i.css({top:0,left:0})}i.show()}};var x=a.extend({},q,f);var s=[],u=false,k,o,n=false,j=0,e=0,l=false,t=false,d,A=null,r,g=[],p=0,h={};var C={panel:'<div id="panel" class="ui-widget ui-widget-content ui-corner-all"><ul id="icons"><li><input class="ui-state-default ui-corner-all" type="text" name="search" value="'+x.search_box_default+'"></li><li class="ui-state-default ui-corner-all"><span class="submitsearch ui-icon ui-icon-search" title="Submit search"></span></li><li class="ui-state-default ui-corner-all"><span class="fullscreen ui-icon ui-icon-arrow-4-diag" title="Toggle full screen"></span></li><li class="ui-state-default ui-corner-all"><span class="shuffle ui-icon ui-icon-shuffle" title="Shuffle images"></span></li><li class="ui-state-default ui-corner-all"><span class="zoomin ui-icon ui-icon-zoomin" title="Larger images"></span></li><li class="ui-state-default ui-corner-all"><span class="zoomout ui-icon ui-icon-zoomout" title="Smaller images"></span></li><li class="ui-state-default ui-corner-all hide"><span class="togglehist ui-icon ui-icon-clock" title="Toggle history panel"></span></li><li class="ui-state-default ui-corner-all hide"><span class="toggleclip ui-icon ui-icon-clipboard" title="Toggle clipboard"></span></li><li class="ui-state-default ui-corner-all hide"><span class="togglemap ui-icon ui-icon-image" title="Map this set"></span></li></ul></div>',sidebar:'<div id="sidebar" class="ui-dialog ui-widget ui-widget-content ui-corner-all"><div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title object-title"></span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div><div class="sidebar_image"></div><div class="sidebar_info"></div></div>',dialog:'<div id="dialog" class="ui-dialog ui-widget ui-widget-content ui-corner-all"><div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title">'+x.alert_title+'</span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div><p><span style="float: left; margin-right: .3em;" class="ui-icon ui-icon-alert"></span><span id="dialog_text"></span></p><div class="ui-dialog-buttonpane ui-widget-content ui-helper-clearfix"><div class="ui-dialog-buttonset"><button type="button" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false"><span class="ui-button-text">Ok</span></button></div></div></div>',loading:'<div id="loading" class="ui-dialog ui-widget ui-widget-content ui-corner-all"><div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title"></span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div><p><span style="float: left; margin-right: .3em;" class="ui-icon ui-icon-info"></span><strong>Tip:&nbsp;</strong><span class="tip"></span></p><p class="results_info hide"></p><div id="progressbar"></div></div>',title:'<div id="title" class="ui-dialog ui-widget ui-widget-content ui-corner-all"><div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title"><p class="title_info"></p></span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div></div>',fs:'<div id="fullsize" class="ui-dialog ui-widget ui-widget-content ui-corner-all"><div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title"></span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div><img src="" alt="" title="" /></div>',hist:'<div id="hist" class="ui-dialog ui-widget ui-widget-content ui-corner-all"><div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title">Your history</span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div><div id="histlist" class="ui-widget ui-state-highlight ui-corner-all hide"><ul class="list"></ul></div></div>',clipboard:'<div id="clipboard" class="ui-dialog ui-widget ui-widget-content ui-corner-all"><div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"><span class="ui-dialog-title">Your clipboard</span><a href="#" class="ui-dialog-titlebar-close ui-corner-all" role="button"><span class="ui-icon ui-icon-closethick">close</span></a></div><div id="clipboardlist" class="ui-widget ui-state-highlight ui-corner-all hide"><ul class="list"></ul><div class="clearfix"></div></div></div>',disabled:'<div id="disabled" class="ui-widget-overlay"></div>',map:'<div id="mapwrapper" class="ui-dialog"><div id="mapcanvas"></div></div>',fsbtn:'<span id="fs_button" class="ui-state-default ui-corner-all fullscreen"><span class="fullscreen ui-icon ui-icon-arrow-4-diag" title="Toggle full screen"></span></span>'};var y={showLoading:function(){var i=a("#loading",w);a("span.ui-dialog-title",i).html(x.loading_msg);i.centerHoriz().centerVert().show()},showDialog:function(i,E){var D=a("#dialog",i);a("#dialog_text",D).html(E);D.centerHoriz().centerVert().show()},populateSidebar:function(i,G){var D=x.api_stub+G;a("#fullsize").hide();var F=a("#sidebar",i);F.css({width:x.sidebar_width,height:i.height()-2*x.padding,top:0,left:i.width()-(x.sidebar_width+2*x.padding),padding:x.padding});var E=a("#disabled",i);E.css({width:x.sidebar_width,height:i.height()-2*x.padding,top:0,left:i.width()-(x.sidebar_width+2*x.padding),padding:x.padding,"z-index":50}).show();if(!F.is(":visible")){F.show()}a.ajax({dataType:"jsonp",url:D,success:function(U){var K=U[0].fields;var Y=x.images_url+K.primary_image_id.substr(0,6)+"/"+K.primary_image_id+x.sidebar_image_suffix+".jpg";var L=K.object;var I='<span id="objname" class="searchable" title="Search for \''+L+"'\">"+L+"</span>";if(K.title){L+=": "+K.title;I+=": "+K.title}var X='<img src="'+Y+'" title="'+L+'" alt="'+L+'" width="'+x.sidebar_image_size+'" height="'+x.sidebar_image_size+'" data-objnum="'+K.object_number+'">';a("span.object-title",F).html('<span class="ui-icon ui-icon-search" style="float: left; margin-right: 2px;"></span>'+I);var Q="";if(x.show_more_link){Q='<div class="ui-widget ui-state-highlight ui-corner-all"><div><span class="ui-icon ui-icon-extlink" style="float:left;"></span><a href="'+x.collections_record_url+K.object_number+'">More details</a></div>';if(x.enable_clipboard){Q+='<div><span class="ui-icon ui-icon-copy" style="float:left;"></span><a data-name="'+L+'" data-objnum="'+K.object_number+'" data-imref="'+K.primary_image_id+'" class="save" href="#" title="Save this object to your clipboard">Save</a></div></div>'}}if(typeof(K.descriptive_line)!="undefined"&&K.descriptive_line!==""&&K.descriptive_line!=["Unknown"]){Q+='<div class="ui-widget ui-state-highlight ui-corner-all">'+K.descriptive_line+"</div>"}Q+='<div class="ui-widget ui-state-highlight ui-corner-all">';Q+="<ul>";for(var T=0;T<x.tombstone.length;T++){var O=x.tombstone[T][0];var V=x.tombstone[T][1];if(typeof(K[V])!="undefined"&&K[V]!==""&&K[V]!=["Unknown"]){Q+="<li><strong>"+O+"</strong>: "+K[V]+"</li>"}}Q+="</ul></div>";Q+='<div class="ui-widget ui-state-highlight ui-corner-all" id="browse">';Q+='<ul class="'+x.tag_style+'">';var H=0;for(T=0;T<x.taxonomy.length;T++){var S=K[x.taxonomy[T]];if(y.countGroups(S)>0){var N=y.ucfirst(x.taxonomy[T]);H++;if(x.tag_style=="list"){Q+="<li><strong>"+N+"</strong>";Q+="<ul>"}for(var R=0;R<S.length;R++){var P=Math.floor(Math.random()*6);var M=S[R];var W=y.ucfirst(M.fields.name);if(M.fields.museumobject_image_count>x.min_category_count&&W!="Unknown"){H++;Q+='<li class="size-'+parseInt(P,10)+'"><a href="#" data-name="'+M.model.split(".")[1]+'" data-pk="'+M.pk+'" data-term="'+W+'" title="Browse images for \''+W+"'\">"+W+"</a>";if(x.image_counts_in_sidebar){Q+="&nbsp;("+M.fields.museumobject_image_count+")"}Q+="</li>"}}if(x.tag_style=="list"){Q+="</ul>"}Q+="</li>"}}if(H===0){Q+="<li>Sorry, no categories for this object.</li>"}Q+='</ul><div class="clearfix"></div></div>';a(".sidebar_image",F).html(X);a(".sidebar_info",F).html(Q).height(F.height()-a(".sidebar_image").outerHeight()-a(".ui-dialog-titlebar",F).outerHeight()).scrollTop(0);var J=new Image();J.src=Y.replace(x.sidebar_image_suffix,x.large_image_suffix);a("#fullsize img",i).attr("src",J.src);a("#fullsize .ui-dialog-title").html(L);E.fadeOut()}})},apiStart:function(){n=true;a("#panel .shuffle").addClass("disabled");a.ajax({dataType:"jsonp",url:y.buildUrl(),success:function(N){if(x.enable_map){for(var H=0;H<g.length;H++){var E=g[H];E.setMap(null)}}g.length=0;if(N.meta.result_count<=x.min_category_count){y.showDialog(w,x.alert_msg_no_images)}else{if(x.show_loading){var D;if(p==0){D=0}else{D=Math.floor(Math.random()*x.tips.length)}a("#loading .tip").html(x.tips[D]);y.showLoading()}if(typeof(o)!="undefined"){clearInterval(o)}if(typeof(k)!="undefined"){clearInterval(k)}s=[];j=0;a("#grid ul li",w).addClass("blank");h.num_results=(N.meta.result_count>x.max_results)?x.max_results:N.meta.result_count;h.display_results=parseInt(x.num_results,10);h.grid_width=Math.floor(Math.sqrt(h.num_results));h.grid_height=h.grid_width;h.max_offset=h.grid_width*h.grid_height;var P=false,J;if(h.category.id!==null){J="Showing "+h.num_results+' images for <span class="">'+y.ucfirst(h.category.name)+": "+y.ucfirst(h.category.term)+"</span>";var K=h.category.id+h.category.name+h.category.term;K=K.replace(/ /gi,"").toLowerCase();if(a.inArray(K,x.browse_hist)==-1){x.browse_hist.push(K);a("#histlist ul").append('<li><a href="#" data-name="'+h.category.name+'" data-pk="'+h.category.id+'" data-term="'+h.category.term+'">'+y.ucfirst(h.category.name)+": "+h.category.term+"</a></li>")}a("#histlist").show()}else{if(h.search_term!==""){J="Showing "+h.num_results+' images for <span class="">'+h.search_term+"</span>";if(a.inArray(h.search_term,x.browse_hist)==-1){a("#histlist ul").append('<li><a href="#" data-search_term="'+h.search_term+'" title="Search for \''+h.search_term+"'\">Search: "+h.search_term+"</a></li>");x.browse_hist.push(h.search_term)}a("#histlist").show()}else{J=x.title_no_term}}if(x.browse_hist.length>x.max_history){a("#histlist li:first").remove();x.browse_hist.shift()}a("#title .title_info",w).html(J);if(p>0){a("#title").show()}a("#progressbar").progressbar({value:0,max:h.max_offset});a("#loading p.results_info",w).html('Loading <strong><span class="loaded">0</span>/'+h.display_results+"</strong> images");e=0;var L=a("#grid>ul:first li",w).size(),M=a("#grid>ul>li",w),I=0,O=0,F=e;for(var G=0;G<M.size();G++){a(M[G]).data("offset",F);I++;if(I==L){I=0;O++;F=O*h.grid_width}else{F++}}n=false;o=setInterval(function(){y.fillCache(x,s)},x.cache_interval);k=setInterval(function(){y.fillTiles(x,s)},x.fill_interval);p++}}});return true},resize:function(F){y.prepareSession(F);a("#grid",w).html("");y.draw(w);e=0;var E=a("#grid>ul:first li",w).size(),D=a("#grid>ul>li",w),G=0,I=0,H=e;for(var i=0;i<D.size();i++){a(D[i]).data("offset",H);G++;if(G==E){G=0;I++;H=I*h.grid_width}else{H++}}},prepareSession:function(i){h.tile_w=x.sizes[i].dim;h.tile_h=x.sizes[i].dim;h.tile_sidebar_image_suffix=x.sizes[i].suff;h.cell_w=h.tile_w+x.tile_margin+2;h.cell_h=h.tile_h+x.tile_margin+2;h.start_rows=Math.ceil(x.height/h.cell_h);h.start_cols=Math.ceil(x.width/h.cell_w)},buildUrl:function(F,i){if(typeof(F)=="undefined"||isNaN(F)){F=0}if(typeof(i)=="undefined"||isNaN(i)){i=1}var D,E;if(h.category.id!==null){D=x.api_stub;D+="?"+h.category.name+"="+h.category.id;D+="&getgroup="+h.category.name;E=y.ucfirst(h.category.term)}else{D=x.api_stub+x.api_search_path;D+="?q="+h.search_term;E=y.ucfirst(h.search_term)}D+="&limit="+i;D+="&offset="+F;D+="&images=1";return D},drawEmptyRow:function(E){var D="<ul>";for(var i=0;i<E;i++){D+=x.blank_tile}D+="</ul>";return D},styleTiles:function(i){a("#grid li",i).css({width:h.tile_w,height:h.tile_h,"margin-right":x.tile_margin,"margin-bottom":x.tile_margin,"border-color":x.tile_border_color})},countGroups:function(i){var E=0;for(var D=0;D<i.length;D++){if(i[0].fields.name!="Unknown"&&i[0].fields.museumobject_image_count>x.min_category_count){E++}}return E},ucfirst:function(i){return i.charAt(0).toUpperCase()+i.substr(1)},draw:function(N){e=a("#grid ul:first li:first",N).data("offset");var D=a("#grid",N);D.width(D.width()+N.position().left+N.width());var O={N:Math.ceil(D.position().top/h.cell_h),S:Math.ceil((N.height()-D.position().top+D.height())/h.cell_h),E:Math.ceil((D.position().left+D.width())/h.cell_w),W:Math.ceil(D.position().left/h.cell_w)};var E;for(E in O){O[E]=O[E]<0?0:O[E]}var F;if(O.N){for(var K=0;K<O.N;K++){D.prepend(y.drawEmptyRow(a("#grid ul:first > li",N).size()))}F=true}if(O.S){for(var I=0;I<O.S;I++){D.append(y.drawEmptyRow(a("#grid ul:first > li",N).size()))}F=true}if(O.W){var Q="";for(var H=0;H<O.W;H++){Q+=x.blank_tile}a("#grid ul",N).prepend(Q);F=true}if(O.E){var L="";for(var G=0;G<O.E;G++){L+=x.blank_tile}a("#grid ul",N).append(L);F=true}D.css({top:O.N>0?D.position().top-O.N*h.cell_h:D.position().top,left:O.W>0?D.position().left-O.W*h.cell_w:D.position().left,width:a("#grid ul:first > li",N).length*h.cell_w});y.styleTiles(N);var J={N:Math.floor(D.position().top*-1/h.cell_h),S:Math.floor((D.height()-N.height()+D.position().top)/h.cell_h),E:Math.floor((D.width()-N.width()+D.position().left)/h.cell_w),W:Math.floor(D.position().left*-1/h.cell_w)};for(E in J){J[E]=J[E]<0?0:J[E]}var M=0,P=0;while(M<J.W){a("#grid ul li:first-child").remove();M++;D.css({left:D.position().left+h.cell_w})}M=0;while(M<J.E){a("#grid ul li:last-child").remove();M++}while(P<J.N){a("#grid ul:first-child").remove();P++;D.css({top:D.position().top+h.cell_h})}P=0;while(P<J.S){a("#grid ul:last-child").remove();P++}D.width(a("#grid ul:first > li",N).length*h.cell_w);if(F){y.updateOffsets(N,O,J,x)}},updateOffsets:function(L,M,I,E){e=parseInt(e,10);if(M.N>0){e-=h.grid_width*M.N;if(e<0){e+=h.max_offset}}var G,K;if(M.W>0){G=Math.floor(e/h.grid_width)*h.grid_width;K=G+h.grid_width-1;e-=M.W;if(e<G){e+=h.grid_width}}e+=I.W;e-=I.N*h.grid_width;if(e<0){e=0}j=e-E.limit;var J=a("#grid>ul:first li",L).size(),N=a("#grid>ul");for(var F=0;F<N.size();F++){var D=e+(F*h.grid_width);if(D>=h.max_offset){D-=h.max_offset}M=a("li",N[F]);G=Math.floor(D/h.grid_width)*h.grid_width;K=G+h.grid_width-1;for(var H=0;H<M.size();H++){a(M[H]).data("offset",D);D++;if(D>K){D=G}}D=K+1;if(D>=h.max_offset-1){D-=h.max_offset}}},getImageUrl:function(i,D){var E;try{E=i+D.substr(0,6)+"/"+D+h.tile_sidebar_image_suffix+".jpg"}catch(F){E=""}return E},retrieveFromCache:function(D){var i;for(i in s){if(s[i].offset==D){return s[i]}}if(u){a.ajax({dataType:"jsonp",url:y.buildUrl(D,1),success:function(G){var E,H,I;for(var F=0;F<G.records.length;F++){E=G.records[F];H={};H.offset=D;H.imref=E.fields.primary_image_id;H.num=E.fields.object_number;if(E.fields.title){I=E.fields.object+" "+E.fields.title}else{I=E.fields.object}H.title=I;s.push(H)}}})}return false},fillCache:function(E,i){if(typeof(j)=="undefined"||isNaN(j)||j<0){j=0}if(i.length<h.max_offset){u=false;if(!n){n=true;var D=y.buildUrl(j,E.limit);a.ajax({dataType:"jsonp",url:D,success:function(K){var I,L,M;for(var J=0;J<K.records.length;J++){I=K.records[J];L={};L.offset=j;L.imref=I.fields.primary_image_id;L.num=I.fields.object_number;L.lng=I.fields.longitude;L.lat=I.fields.latitude;if(I.fields.title){M=I.fields.object+" "+I.fields.title}else{M=I.fields.object}L.title=M;i.push(L);j++;if(E.enable_map&&A&&L.lat&&L.lng){var H=E.images_url+L.imref.substr(0,6)+"/"+L.imref+"_jpg_s.jpg";var F=new google.maps.LatLng(L.lat,L.lng);var G=new google.maps.Marker({position:F,title:L.title,objnum:L.num});google.maps.event.addListener(G,"click",function(N){y.populateSidebar(w,this.objnum)});g.push(G);if(A&&!G.map){G.setMap(A)}}}if(j>=h.max_offset&&i.length<h.max_offset){j=0}n=false;a("#progressbar").progressbar({value:i.length});a("#loading .loaded").html(i.length)}})}}else{a("#panel .shuffle").removeClass("disabled");l=true;clearInterval(o);u=true;setTimeout(y.hideLoading,E.hide_loader_time);a("#loading .loaded").html(h.display_results);a("#loading span.ui-dialog-title").html("Done.")}},hideLoading:function(){a("#loading").fadeOut()},fillTile:function(D,i){if(D&&typeof(D)!="undefined"){D.css({"background-image":"url("+y.getImageUrl(x.images_url,i.imref)+")"});D.attr("title",i.title+" ["+i.num+"]");D.data("objnum",i.num);D.removeClass("blank")}},fillTiles:function(F,i){var D,E;switch(F.fill_direction){case"forwards":D=a("ul li.blank:first");break;case"backwards":D=a("ul li.blank:last");break;case"random":E=a("ul li.blank");D=a(E[Math.floor(Math.random()*E.length)]);break;default:D=a("ul li.blank:first");break}var G=y.retrieveFromCache(D.data("offset"),i);if(G){y.fillTile(D,G)}}};h.category=x.category;h.search_term=x.search_term;h.current_size=x.start_size;y.prepareSession(h.current_size);x.sidebar_width=x.sidebar_image_size;x.browse_hist=[];x.cliplist=[];x.clipboard=[];var B='<div id="grid">';for(var v=0;v<h.start_rows;v++){B+=y.drawEmptyRow(h.start_cols)}B+="</div>";this.html(B);var b=a("#grid",this);x.start={top:this.position().top,left:this.position().left};x.fullscreen=false;this.css({width:x.width,height:x.height,"background-color":x.background_color,border:x.wall_border});b.css({width:h.cell_w*h.start_cols});y.styleTiles();var c;for(c in C){b.after(C[c])}a("#panel",this).centerHoriz().css({bottom:0});if(x.enable_history){a("span.togglehist","#panel").parent().removeClass("hide")}if(x.enable_clipboard){a("span.toggleclip","#panel").parent().removeClass("hide")}if(x.enable_map&&typeof(google)!="undefined"){r=new google.maps.LatLng(x.map_start_lat,x.map_start_lng);var z={zoom:3,center:r,mapTypeId:google.maps.MapTypeId.TERRAIN};A=new google.maps.Map(document.getElementById("mapcanvas"),z);for(var v=0;v<g.length;v++){var m=g[v];if(m.map==null){g[v].setMap(A)}}a("span.togglemap","#panel").parent().removeClass("hide")}if(x.hide_controls_on_load){a("#fs_button",this).show()}else{a("#panel",this).show()}if(x.show_loading_numbers){a("#loading p.results_info",w).show()}y.apiStart(x);a("#grid",this).draggable({cursor:"pointer",delay:150,stop:function(){y.draw(a(this.parentNode))}});a("#loading",this).draggable({containment:"parent"});a("#fullsize",this).draggable({containment:"parent",stop:function(){t=true}});a("#hist",this).draggable({containment:"parent"});a("#clipboard",this).draggable({containment:"parent"});this.delegate(".ui-icon","mouseover",function(i){a(this).parent().addClass("ui-state-hover")}).delegate(".ui-icon","mouseout",function(i){a(this).parent().removeClass("ui-state-hover")}).delegate(".fullscreen","click",function(i){i.stopImmediatePropagation();i.preventDefault();var D=a("#sidebar",w);if(x.fullscreen){a("body").css({overflow:"auto"});w.prependTo(d).animate({width:x.width,height:x.height},x.fullscreen_speed,function(){if(D.is(":visible")){D.animate({width:x.sidebar_width,height:w.height()-2*x.padding,top:0,left:w.width()-(x.sidebar_width+2*x.padding),padding:x.padding},x.fullscreen_speed,function(){})}a("#sidebar").hide();a("#panel").centerHoriz().css({bottom:0});a("#loading").centerHoriz();x.fullscreen=false;y.draw(w);if(A){google.maps.event.trigger(A,"resize");a("#mapwrapper",w).centerHoriz().centerVert()}})}else{d=w.parent();w.prependTo(a("body"));a("body").css({overflow:"hidden"});a(window).scrollTop(0);w.animate({width:a(document).width(),height:a(window).height()},x.fullscreen_speed,function(){if(D.is(":visible")){D.animate({width:x.sidebar_width,height:w.height()-2*x.padding,top:0,left:w.width()-(x.sidebar_width+2*x.padding),padding:x.padding},x.fullscreen_speed,function(){a(".sidebar_info",D).height(D.height()-a(".sidebar_image").height())})}a("#panel").centerHoriz().css({bottom:0});a("#loading").centerHoriz();x.fullscreen=true;y.draw(w);if(A){google.maps.event.trigger(A,"resize");a("#mapwrapper",w).centerHoriz().centerVert()}if(!a("#panel").is(":visible")){a("#panel").show()}if(!a("#title").is(":visible")){a("#title").show()}})}}).delegate("#panel span.zoomin","click",function(i){i.preventDefault();var D=x.sizes.length-1;if(h.current_size<D){h.current_size++;y.resize(h.current_size)}else{y.showDialog(w,x.alert_msg_zoom_max)}}).delegate("#panel span.zoomout","click",function(i){if(h.current_size>0){h.current_size--;y.resize(h.current_size)}else{y.showDialog(w,x.alert_msg_zoom_min)}}).delegate("#panel span.togglehist","click",function(i){a("#hist",w).toggle("fast")}).delegate("#panel span.toggleclip","click",function(i){a("#clipboard",w).toggle("fast")}).delegate("#panel span.togglemap","click",function(i){a("#mapwrapper",w).toggle("fast",function(E){var D=a(this);D.centerHoriz().centerVert();if(D.is(":visible")){google.maps.event.trigger(A,"resize");A.setCenter(r)}})}).delegate("#panel span.submitsearch","click",function(D){var i=a('#panel input[name="search"]',w).val();if(i!==""&&i!=x.search_box_default){h.category={id:null,name:"",term:""};h.search_term=i;y.apiStart(x)}else{y.showDialog(w,x.alert_msg_enter_search)}}).delegate('#panel input[name="search"]',"keyup",function(E){E.preventDefault();var D=(E.keyCode?E.keyCode:E.which);if(D==13){var i=a(this).val();if(i!==""&&i!=x.search_box_default){h.category={id:null,name:"",term:""};h.search_term=i;y.apiStart(x)}else{y.showDialog(w,x.alert_msg_enter_search)}}}).delegate('#panel input[name="search"]',"focus",function(i){i.preventDefault();a(this).val("")}).delegate('#panel input[name="search"]',"click",function(i){i.preventDefault();a(this).val("")}).delegate("#histlist a","click",function(i){i.preventDefault();if(a(this).data("search_term")){h.category={id:null,name:"",term:""};h.search_term=a(this).data("search_term")}else{h.category={id:a(this).data("pk"),name:a(this).data("name"),term:a(this).data("term")}}y.apiStart(x)}).delegate(".searchable","click",function(D){var i=a(this).html();a('#panel input[name="search"]',w).val(i);if(i!==""&&i!=x.search_box_default){h.category={id:null,name:"",term:""};h.search_term=i;y.apiStart(x)}else{y.showDialog(w,x.alert_msg_enter_search)}}).delegate("#panel span.shuffle","click",function(I){if(l){var H=[],E=[],D=a("#grid li",w),G=0;for(var J=0;J<h.max_offset;J++){E[Math.random()*1]=J}for(var F in E){H.push(F)}H.sort();for(var i in H){y.fillTile(a(D[G]),y.retrieveFromCache(E[H[i]],s));G++}}}).delegate(".ui-dialog-titlebar-close","click",function(i){i.preventDefault();a(this).parent().parent().hide()}).delegate("button","click",function(i){i.preventDefault();a("#dialog",w).hide()}).delegate("#grid ul li","click",function(i){y.populateSidebar(w,a(this).data("objnum"))}).delegate("#sidebar a.save","click",function(E){E.preventDefault();var G=a(this).data("objnum"),i=a(this).data("imref");var D={objnum:G,name:a(this).data("name"),img:x.images_url+i.substr(0,6)+"/"+i+"_jpg_s.jpg"};if(a.inArray(a(this).data("objnum"),x.cliplist)==-1){x.cliplist.push(G);x.clipboard.push(D);var F='<li data-objnum="'+G+'">';F+='<img src="'+D.img+'" alt="'+D.name+'" title="'+D.name+'" />';F+="</li>";a("#clipboardlist ul").append(F);a("#clipboardlist").show()}}).delegate("#clipboard li","click",function(i){y.populateSidebar(w,a(this).data("objnum"))}).delegate("#sidebar a.close","click",function(i){i.preventDefault();a("#sidebar",w).hide()}).delegate("#browse a","click",function(i){i.preventDefault();h.category={id:a(this).data("pk"),name:a(this).data("name"),term:a(this).data("term")};y.apiStart();a('#panel input[name="search"]',w).val("New search")}).delegate("#sidebar img","click",x.event_click_sidebar_img)}})(jQuery);